"use strict";define(function(require,exports,module){var $=require("jquery"),common=require("js/common");require("js/jquery.ui.widget")($),require("js/jquery.iframe-transport")($),require("js/jquery.fileupload")($),require("js/jquery.fileupload-process")($),require("js/jquery.fileupload-validate")($);var H5FIleUpload=React.createClass({displayName:"H5FIleUpload",componentDidMount:function(){var me=this,url="/upload/server/php/",types=me.props["data-acceptFileTypes"];types?"images"==types&&(types=/(\.|\/)(gif|jpe?g|png)$/i):types=/(\.|\/)(\w*)$/i;var dataErrorFun=me.props["data-errorFun"],dataSucFun=me.props["data-sucFun"],maxNumberOfFiles=me.props["data-count"],options={url:url,dataType:"json",acceptFileTypes:types,maxFileSize:me.props["data-size"]?me.props["data-size"]:1e7,maxNumberOfFiles:maxNumberOfFiles?parseInt(maxNumberOfFiles):100,singleFileUploads:maxNumberOfFiles?!1:!0};$(me.refs.h5fileupload_input).fileupload(options).on("fileuploadadd",function(e,data){}).on("fileuploadprogressall",function(e,data){$(me.refs.h5fileupload_input).attr("disabled",!0);var progress=parseInt(data.loaded/data.total*100,10);$(me.refs.progress_bar).css("width",progress+"%")}).on("fileuploaddone",function(e,data){$(me.refs.h5fileupload_input).attr("disabled",!1);var arr=me.state.files;options.singleFileUploads?Array.prototype.push.apply(arr,data.result.files):arr=data.result.files,me.setState({files:arr}),dataSucFun&&dataSucFun(arr)}).on("fileuploadprocessalways",function(e,data){var index=data.index,file=data.files[index];file.error&&dataErrorFun&&dataErrorFun(file.error)}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")},deleteFile:function(fid){var me=this,dataErrorFun=me.props["data-errorFun"];$.ajax({type:"POST",url:common.createUrl($(".htmlbody").attr("data-ajax-submit")),data:{file_id:fid},beforeSend:function(){$("body").loadingOverlay()},success:function(data){$("body").loadingOverlay("remove"),data.suc?!function(){var arr=me.state.files,newArr=[];$.each(arr,function(index,file){file.file_id!=fid&&newArr.push(file)}),me.setState({files:newArr})}():dataErrorFun&&dataErrorFun(data.msg)},error:function(XMLHttpRequest,textStatus){$("body").loadingOverlay("remove"),dataErrorFun&&dataErrorFun(JSON.stringify(XMLHttpRequest))},dataType:"json"})},getInitialState:function(){var files=[];return this.props["data-files"]&&this.props["data-files"].length>0&&(files=this.props["data-files"]),{files:files}},render:function(){var me=this,text=me.props["data-inputText"]?me.props["data-inputText"]:"上传",dataFileUploadExDom=me.props["data-fileUploadExDom"],dataNofilesdom=me.props["data-nofilesdom"],filesDom=[];dataNofilesdom||$.each(me.state.files,function(index,file){filesDom.push(React.createElement("div",null,React.createElement("span",{className:"glyphicon glyphicon-paperclip"})," ",file.file_name,"  (",file.size,")",React.createElement("a",{href:"###",onClick:function(){me.deleteFile(file.file_id)}},"删除")))});var mSize=(me.props["data-size"]/1e3/1e3).toFixed(2);return React.createElement("div",{className:"h5fileupload"},React.createElement("span",{className:"btn btn-primary fileinput-button"},React.createElement("i",{className:"glyphicon glyphicon-plus"}),React.createElement("span",null,text),React.createElement("input",{ref:"h5fileupload_input",className:"h5fileupload_input",type:"file",name:"files[]",multiple:!0})),dataFileUploadExDom,React.createElement("div",{className:"sizeTip"},"每个上传文件限制",mSize,"M"),React.createElement("div",{ref:"progress",className:"progress"},React.createElement("div",{ref:"progress_bar",className:"progress-bar progress-bar-success"})),React.createElement("div",{ref:"files",className:"files"},filesDom),React.createElement("br",null))}});module.exports=H5FIleUpload});